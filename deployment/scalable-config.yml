# Configuração de Deploy Escalável - DentCare System
# Suporta 50.000+ usuários simultâneos com arquitetura distribuída

version: '3.8'

services:
  # Load Balancer - Nginx
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app1
      - app2
      - app3
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G

  # Application Servers
  app1:
    build: .
    environment:
      - NODE_ENV=production
      - DATABASE_WRITE_URL=${DATABASE_WRITE_URL}
      - DATABASE_READ_URLS=${DATABASE_READ_URLS}
      - REDIS_CLUSTER_NODES=${REDIS_CLUSTER_NODES}
      - SESSION_SECRET=${SESSION_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AI_SERVICE_PORT=3001
    ports:
      - "5001:5000"
    depends_on:
      - postgres-master
      - redis-cluster
    restart: always
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 16G

  app2:
    build: .
    environment:
      - NODE_ENV=production
      - DATABASE_WRITE_URL=${DATABASE_WRITE_URL}
      - DATABASE_READ_URLS=${DATABASE_READ_URLS}
      - REDIS_CLUSTER_NODES=${REDIS_CLUSTER_NODES}
      - SESSION_SECRET=${SESSION_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AI_SERVICE_PORT=3002
    ports:
      - "5002:5000"
    depends_on:
      - postgres-master
      - redis-cluster
    restart: always
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 16G

  app3:
    build: .
    environment:
      - NODE_ENV=production
      - DATABASE_WRITE_URL=${DATABASE_WRITE_URL}
      - DATABASE_READ_URLS=${DATABASE_READ_URLS}
      - REDIS_CLUSTER_NODES=${REDIS_CLUSTER_NODES}
      - SESSION_SECRET=${SESSION_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AI_SERVICE_PORT=3003
    ports:
      - "5003:5000"
    depends_on:
      - postgres-master
      - redis-cluster
    restart: always
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G

  # Database Cluster
  postgres-master:
    image: postgres:15
    environment:
      - POSTGRES_DB=dentcare
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_REPLICATION_MODE=master
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=${POSTGRES_REPLICATION_PASSWORD}
    volumes:
      - postgres_master_data:/var/lib/postgresql/data
      - ./postgres-master.conf:/etc/postgresql/postgresql.conf
    ports:
      - "5432:5432"
    restart: always
    deploy:
      resources:
        limits:
          cpus: '16'
          memory: 32G

  postgres-replica1:
    image: postgres:15
    environment:
      - POSTGRES_MASTER_SERVICE=postgres-master
      - POSTGRES_REPLICATION_MODE=slave
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=${POSTGRES_REPLICATION_PASSWORD}
      - POSTGRES_MASTER_PORT_NUMBER=5432
    volumes:
      - postgres_replica1_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    depends_on:
      - postgres-master
    restart: always
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 16G

  postgres-replica2:
    image: postgres:15
    environment:
      - POSTGRES_MASTER_SERVICE=postgres-master
      - POSTGRES_REPLICATION_MODE=slave
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=${POSTGRES_REPLICATION_PASSWORD}
      - POSTGRES_MASTER_PORT_NUMBER=5432
    volumes:
      - postgres_replica2_data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    depends_on:
      - postgres-master
    restart: always
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 16G

  # Redis Cluster
  redis-node1:
    image: redis:7-alpine
    command: redis-server /etc/redis/redis.conf --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    volumes:
      - ./redis-cluster.conf:/etc/redis/redis.conf
      - redis1_data:/data
    ports:
      - "7001:6379"
      - "17001:16379"
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  redis-node2:
    image: redis:7-alpine
    command: redis-server /etc/redis/redis.conf --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    volumes:
      - ./redis-cluster.conf:/etc/redis/redis.conf
      - redis2_data:/data
    ports:
      - "7002:6379"
      - "17002:16379"
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  redis-node3:
    image: redis:7-alpine
    command: redis-server /etc/redis/redis.conf --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    volumes:
      - ./redis-cluster.conf:/etc/redis/redis.conf
      - redis3_data:/data
    ports:
      - "7003:6379"
      - "17003:16379"
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  # Microserviços Especializados
  ai-service:
    build:
      context: .
      dockerfile: Dockerfile.ai
    environment:
      - NODE_ENV=production
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - REDIS_CLUSTER_NODES=${REDIS_CLUSTER_NODES}
    ports:
      - "3001:3001"
    depends_on:
      - redis-cluster
    restart: always
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 16G

  media-service:
    build:
      context: .
      dockerfile: Dockerfile.media
    environment:
      - NODE_ENV=production
      - CDN_STORAGE_PATH=/app/uploads
    volumes:
      - media_storage:/app/uploads
    ports:
      - "3004:3004"
    restart: always
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G

  queue-workers:
    build: .
    command: node dist/workers.js
    environment:
      - NODE_ENV=production
      - REDIS_CLUSTER_NODES=${REDIS_CLUSTER_NODES}
      - DATABASE_WRITE_URL=${DATABASE_WRITE_URL}
    depends_on:
      - redis-cluster
      - postgres-master
    restart: always
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2'
          memory: 4G

volumes:
  postgres_master_data:
  postgres_replica1_data:
  postgres_replica2_data:
  redis1_data:
  redis2_data:
  redis3_data:
  media_storage:

networks:
  default:
    driver: bridge